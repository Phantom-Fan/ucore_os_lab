#Lab7 Report
2013011321 范子豪

##EX0 填入以前代码 并做update
在trap.c中, 需要对时钟中断函数进行更新  
需要用run\_timer\_list()代替sched\_class\_proc\_tick()  

## EX1
请在实验报告中给出内核级信号量的设计描述，并说其大致执行流流程。  
请在实验报告中给出给用户态进程/线程提供信号量机制的设计方案，并比较说明给内核级提供信号量机制的异同。  

####内核级信号量的设计描述与执行流程

设计上和视频中讲解的基本一致, 流程上  

- __down 
    - 屏蔽中断
    - 信号量的value--, 如果小于等于0则加入等待队列并且当前进程并阻塞当前进程
    - 对应原理课的P函数
- __up
    - 屏蔽中断
    - 信号量的value++，如果等待队列非空则唤醒等待中的进程
    - 对应原理课的V函数 

####用户态进程信号量机制的设计

用户态不能使用`local_intr_save`或者`local_intr_restore`, 也不应该使用, 否则会导致无法处理异常、破坏系统的功能。  

只需要禁止用户进程之间的切换即可完成用户态信号量的实现. 这需要在内核中增加一个标记并且在中断处理例程中判断是否允许用户级进程切换.

## EX2

请在实验报告中给出内核级条件变量的设计描述，并说其大致执行流流程。  
请在实验报告中给出给用户态进程/线程提供条件变量机制的设计方案，并比较说明给内核级提供条件变量机制的异同。  

####内核级条件变量的实现

- 条件变量结构体内保存: 信号量(锁), 等待条件变量的进程数和owner管程指针
- 管程结构体包含: 控制进入管程的信号量, 控制等待进程的信号量, 等待进程个数的计数器和条件变量指针
- 通过`cond_wait`等待条件变量, 当如果条件不满足, 挂起当前进程
- 通过`cond_singal`通知其他等待条件变量进程, 如果有等待改变量的进程, 则利用信号量唤醒, 并将自己进入等待状态.

####用户态条件变量的实现

原子性的保证是通过信号量实现的, 通过用户态信号量的实现, 就可以实现用户态的条件变量. 